<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RMPOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    .container { max-width: 440px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); text-align: center; }
    .logo { width: 110px; margin-bottom: 12px; }
    h1 { color: #003087; margin-bottom: 8px; }
    .price { font-size: 1.4em; margin: 18px 0; color: #222; }
    footer { margin-top: 45px; font-size: 0.85em; color: #555; }
    #pago-form { margin-bottom: 20px; }
    .hidden { display: none; }
    .success { color: green; }
    .error { color: red; }
    .recargo { font-size: 0.95em; color: #555; }
    #whatsapp-btn { margin-top: 18px; padding: 10px 18px; background: #25D366; color: #fff; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
    #whatsapp-btn:hover { background: #128C7E; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://github.com/rimedhn/capturadepagospaypal/blob/main/rmposlogo.jpg?raw=true" alt="Logo RMPOS" class="logo" />
    <h1>Realiza tu pago - RM POS. Plataformas Digitales a la medida de tu negocio</h1>
    <p id="instruccion">Ingrese su ID de pago para realizar el pago:</p>
    <form id="pago-form">
      <input type="text" id="idpago" placeholder="ID de pago" required>
      <button type="submit">Consultar</button>
    </form>
    <div id="datos-cliente" class="hidden">
      <div><strong>Cliente:</strong> <span id="cliente"></span></div>
      <div class="price">
        <strong>Valor plan:</strong> $<span id="valor_plan"></span> <br>
        <span class="recargo">Recargo pago TC 5%: $<span id="recargo"></span></span><br>
        <strong>Monto total a pagar:</strong> $<span id="total"></span> USD
      </div>
      <div id="paypal-button-container"></div>
    </div>
    <div id="mensaje"></div>
    <div id="simular-container">
      <button id="simular-btn" style="margin-top:10px;padding:7px 14px;">Simular pago</button>
    </div>
    <div id="whatsapp-container"></div>
    <footer>
      &copy; 2025 RMPOS. Todos los derechos reservados. indime.hn@gmail.com, (+504) 9359-3126.
    </footer>
  </div>

  <!-- El SDK de PayPal se carga dinámicamente -->
  <script>
    const scriptApi = "https://script.google.com/macros/s/AKfycbyiyJQc_tgS6aBtAesv8hKjXB-3CbRhXGFH0jZ2WR84NFZA_p5i0r40WCehu6j2qb4y/exec";
    const whatsappNumber = "50493593126"; // Número del negocio sin "+" ni espacios
    let pagoActual = null;
    let fechaConfirmacion = "";
    let paypalLoaded = false;

    // Cargar el Client ID desde Apps Script y luego el SDK de PayPal
    async function cargarPayPalSDK() {
      const res = await fetch(scriptApi + "?api=paypal");
      const clientId = await res.text();
      const script = document.createElement("script");
      script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD`;
      script.onload = function() { paypalLoaded = true; }
      document.head.appendChild(script);
    }
    cargarPayPalSDK();

    async function consultarPago(id) {
      document.getElementById("mensaje").textContent = "";
      document.getElementById("whatsapp-container").innerHTML = "";
      if (!id) return;
      const res = await fetch(scriptApi + "?idpago=" + id);
      const data = await res.json();
      if (data && data.idpago) {
        pagoActual = data;
        document.getElementById("cliente").textContent = data.cliente;
        document.getElementById("valor_plan").textContent = parseFloat(data.valor_plan).toFixed(2);
        const recargo = Math.round(data.valor_plan * 0.05 * 100) / 100;
        document.getElementById("recargo").textContent = recargo.toFixed(2);
        const total = Math.round((parseFloat(data.valor_plan) + recargo) * 100) / 100;
        document.getElementById("total").textContent = total.toFixed(2);
        document.getElementById("datos-cliente").classList.remove("hidden");
        // Esperar a que el SDK de PayPal esté cargado
        const interval = setInterval(() => {
          if (paypalLoaded && window.paypal) {
            clearInterval(interval);
            renderPayPalButton(total);
          }
        }, 200);
        document.getElementById("pago-form").classList.add("hidden");
        document.getElementById("instruccion").textContent = "Confirme y realice su pago:";
      } else {
        document.getElementById("datos-cliente").classList.add("hidden");
        document.getElementById("mensaje").innerHTML = "<span class='error'>Pago no encontrado.</span>";
      }
    }

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const idpagoParam = params.get('idpago');
      if (idpagoParam) {
        document.getElementById("idpago").value = idpagoParam;
        consultarPago(idpagoParam);
      }
    };

    document.getElementById("pago-form").onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById("idpago").value.trim();
      consultarPago(id);
    };

    function getFechaConfirmacion() {
      const d = new Date();
      const pad = n => n.toString().padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function renderWhatsAppButton(resumen) {
      const container = document.getElementById("whatsapp-container");
      container.innerHTML = "";
      const btn = document.createElement("button");
      btn.id = "whatsapp-btn";
      btn.textContent = "Enviar resumen por WhatsApp";
      btn.onclick = function() {
        const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(resumen)}`;
        window.open(url, "_blank");
      };
      container.appendChild(btn);
    }

    function renderPayPalButton(monto) {
      document.getElementById("paypal-button-container").innerHTML = "";
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: { value: monto.toFixed(2) }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            fechaConfirmacion = getFechaConfirmacion();
            document.getElementById("mensaje").innerHTML =
              "<span class='success'>¡Pago realizado por " + details.payer.name.given_name + "!</span>";
            // Guardar estatus Confirmado, confirmado Si y fecha en Google Sheet
            fetch(scriptApi, {
              method: "POST",
              body: JSON.stringify({
                idpago: pagoActual.idpago,
                estatus: "Confirmado",
                confirmado: "Si",
                fecha_confirmacion: fechaConfirmacion
              }),
              headers: { "Content-Type": "application/json" }
            });

            // Mostrar botón WhatsApp con resumen
            const resumen = `Pago PayPal realizado en RMPOS\nCliente: ${pagoActual.cliente}\nID de pago: ${pagoActual.idpago}\nMonto pagado: $${monto.toFixed(2)} USD\nFecha confirmación: ${fechaConfirmacion}`;
            renderWhatsAppButton(resumen);

            document.getElementById("datos-cliente").classList.add("hidden");
          });
        }
      }).render('#paypal-button-container');
    }

    // Simular pago (para testear ventana de confirmación)
    document.getElementById("simular-btn").onclick = function() {
      if (!pagoActual) {
        document.getElementById("mensaje").innerHTML = "<span class='error'>Primero consulta un ID de pago.</span>";
        return;
      }
      const total = Math.round((parseFloat(pagoActual.valor_plan) * 1.05) * 100) / 100;
      const fechaConfirmacion = getFechaConfirmacion();
      document.getElementById("mensaje").innerHTML =
        "<span class='success'>¡Pago SIMULADO por " + pagoActual.cliente + "!</span>";
      const resumen = `Pago PayPal realizado en RMPOS\nCliente: ${pagoActual.cliente}\nID de pago: ${pagoActual.idpago}\nMonto pagado: $${total.toFixed(2)} USD\nFecha confirmación: ${fechaConfirmacion}`;
      renderWhatsAppButton(resumen);
      document.getElementById("datos-cliente").classList.add("hidden");
    };
    
  </script>
</body>
</html>
