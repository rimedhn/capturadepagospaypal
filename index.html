<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RMPOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    .container { max-width: 440px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); text-align: center; }
    .logo { width: 110px; margin-bottom: 12px; }
    h1 { color: #003087; margin-bottom: 8px; }
    .price { font-size: 1.4em; margin: 18px 0; color: #222; }
    footer { margin-top: 45px; font-size: 0.85em; color: #555; }
    #pago-form { margin-bottom: 20px; }
    .hidden { display: none; }
    .success { color: green; }
    .error { color: red; }
    .recargo { font-size: 0.95em; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://github.com/rimedhn/capturadepagospaypal/blob/main/rmposlogo.jpg?raw=true" alt="Logo RMPOS" class="logo" />
    <h1>Realiza tu pago - RM POS. Plataformas Digitales a la medida de tu negocio</h1>
    <p id="instruccion">Ingrese su ID de pago para realizar el pago:</p>
    <form id="pago-form">
      <input type="text" id="idpago" placeholder="ID de pago" required>
      <button type="submit">Consultar</button>
    </form>
    <div id="datos-cliente" class="hidden">
      <div><strong>Cliente:</strong> <span id="cliente"></span></div>
      <div class="price">
        <strong>Valor plan:</strong> $<span id="valor_plan"></span> <br>
        <span class="recargo">Recargo 5%: $<span id="recargo"></span></span><br>
        <strong>Monto total a pagar:</strong> $<span id="total"></span> USD
      </div>
      <div id="paypal-button-container"></div>
    </div>
    <div id="mensaje"></div>
    <footer>
      &copy; 2025 RMPOS. Todos los derechos reservados. indime.hn@gmail.com, (+504) 9359-3126.
    </footer>
  </div>

  <!-- SDK de PayPal -->
  <script src="https://www.paypal.com/sdk/js?client-id=ATawzIp6oN1KZSZcZBIbTrpUecM-SVd9LsOPxmciCzDJ4iHDCv0RnDJKoroz263L5aueHh7NUn1N1yzz&currency=USD"></script>
  <script>
    const scriptApi = "https://script.google.com/macros/s/AKfycbyiyJQc_tgS6aBtAesv8hKjXB-3CbRhXGFH0jZ2WR84NFZA_p5i0r40WCehu6j2qb4y/exec";
    let pagoActual = null;

    // Función para consultar y mostrar el pago
    async function consultarPago(id) {
      document.getElementById("mensaje").textContent = "";
      if (!id) return;
      const res = await fetch(scriptApi + "?idpago=" + id);
      const data = await res.json();
      if (data && data.idpago) {
        pagoActual = data;
        document.getElementById("cliente").textContent = data.cliente;
        document.getElementById("valor_plan").textContent = parseFloat(data.valor_plan).toFixed(2);
        const recargo = Math.round(data.valor_plan * 0.05 * 100) / 100;
        document.getElementById("recargo").textContent = recargo.toFixed(2);
        const total = Math.round((parseFloat(data.valor_plan) + recargo) * 100) / 100;
        document.getElementById("total").textContent = total.toFixed(2);
        document.getElementById("datos-cliente").classList.remove("hidden");
        renderPayPalButton(total);
        document.getElementById("pago-form").classList.add("hidden");
        document.getElementById("instruccion").textContent = "Confirme y realice su pago:";
      } else {
        document.getElementById("datos-cliente").classList.add("hidden");
        document.getElementById("mensaje").innerHTML = "<span class='error'>Pago no encontrado.</span>";
      }
    }

    // Consulta automática si viene el parámetro ?idpago= en la URL
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const idpagoParam = params.get('idpago');
      if (idpagoParam) {
        document.getElementById("idpago").value = idpagoParam;
        consultarPago(idpagoParam);
      }
    };

    // Consulta manual por formulario
    document.getElementById("pago-form").onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById("idpago").value.trim();
      consultarPago(id);
    };

    function renderPayPalButton(monto) {
      document.getElementById("paypal-button-container").innerHTML = "";
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: { value: monto.toFixed(2) }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            document.getElementById("mensaje").innerHTML =
              "<span class='success'>¡Pago realizado por " + details.payer.name.given_name + "!</span>";
            // Guardar estatus pagado y confirmacion en Google Sheet
            fetch(scriptApi, {
              method: "POST",
              body: JSON.stringify({
                idpago: pagoActual.idpago,
                estatus: "pagado",
                confirmacion: "Pago PayPal confirmado"
              }),
              headers: { "Content-Type": "application/json" }
            });
            document.getElementById("datos-cliente").classList.add("hidden");
          });
        }
      }).render('#paypal-button-container');
    }
  </script>
</body>
</html>
